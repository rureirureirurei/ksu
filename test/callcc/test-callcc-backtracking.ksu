;2
; Sophisticated backtracking example
(define cont-stack (box nil))

(define (choose opts)
  (call/cc k
    (begin
      (set! cont-stack (pair (pair k (snd opts)) (unwrap cont-stack)))
      (fst opts)
    )
  )
)

(define count (box 0))

(define (fail)
  (if (nil? (unwrap cont-stack))
      (print (unwrap count))
      (let* (
             [top (fst (unwrap cont-stack))]
             [k (fst top)]
             [remaining (snd top)])
        (begin
          (set! cont-stack (snd (unwrap cont-stack)))
          (if (nil? remaining)
              (fail)
              (begin
                (set! cont-stack (pair (pair k (snd remaining)) (unwrap cont-stack)))
                (k (fst remaining))
              )
          )
        )
      )
  )
)

(define (range n) (if (= n 1) 
  (pair 1 nil)
  (pair n (range (- n 1)))
))

(define (search)
  (let* (
        [a (choose (range 5))]
        [b (choose (range 5))]
        [c (choose (range 5))]
       )
        (begin
          (if (eq? (+ (* b b) (* c c)) (* a a))
              (begin
                (set! count (+ 1 (unwrap count)))
                ;(print (pair a (pair b (pair c nil))))
                (fail)
              )
              (fail)
          )
        )
      )
    )

(search)
